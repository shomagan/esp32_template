<html lang="en">
    <head>
        <title>Download OS</title>
        <meta charset="utf-8">
        <script>
            let addr = "";
            let os1_index = 0;
            let os1_len = 0;
            let os2_index = 0;
            let os2_len = 0;
            let file_os1 = 0;
            let file_os2 = 0;
            let current_os = 0;
            let main_os = 0;
            let create = function( id ) { return document.createElement( id ); };
            function send_file(form){
                let result = true;
                if (current_os === main_os){
                    let send_file = new XMLHttpRequest();
                    FD  = new FormData();
                    send_file.timeout = 20000;
                    send_file.ontimeout = function(){
                        console.log("Server is not responding");
                        alert("Server is not responding");
                    }
                    send_file.onloadend = function(){
                        console.log("successful download file");
                        if (main_os===1) {
                            window.location.assign(addr + '/uploaddone_os2.html');
                        }else if(main_os===2){
                            window.location.assign(addr + '/uploaddone_os1.html');
                        }
                    }
                    if (main_os===1){
                        console.log("loading os 2");
                        send_file.open("POST", addr + '/download_os2.key');
                        FD.append( "datafile", file_os2 );
                        let link_req = send_file.send(FD);

                    }else if(main_os===2){
                        console.log("loading os 1");
                        send_file.open("POST",addr + '/download_os1.key');
                        FD.append( "datafile", file_os1 );
                        let link_req = send_file.send(FD);

                    }
                }else{
                    alert("Current os is not main");
                }
            }
            function file(form){
                let f = document.forms[form]["datafile"].files[0];
                const reader = new FileReader();
                reader.readAsArrayBuffer(f);
                reader.onload = function(){
                    let bin_32 = new Uint32Array(reader.result);
                    let bin_8 = new Uint8Array(reader.result);
                    os1_index = bin_32[0];
                    if (os1_index===1 && (bin_8.length<=(1024*1024))){
                        os1_len = (bin_8[4]<<24)+(bin_8[5]<<16)+(bin_8[6]<<8)+bin_8[7];
                        if (os1_len<(512*1024)){
                            let os2_start =os1_len + 4
                            os2_index = bin_32[os2_start/4];
                            if (os2_index==2){
                                os2_len = (bin_8[os2_start+4]<<24)+(bin_8[os2_start+5]<<16)+(bin_8[os2_start+6]<<8)+bin_8[os2_start+7];
                                if (os2_len<(512*1024)){
                                    file_os1 = new Blob([bin_8.slice(0,os2_start)], {type: "text/plain"});
                                    file_os2 = new Blob([bin_8.slice(os2_start)], {type: "text/plain"});
                                    document.getElementById("download_button").style.display = "inline";
                                }else{
                                    alert("icn bin file: len os1 is incorrect")
                                }
                            }else{
                                alert("icn bin file: os2 index have impossible value")
                            }
                        }else{
                            alert("ich bin file: len os1 is incorrect");
                        }
                    }else{
                        alert("ich bin file: file is incorrect " + os1_index + " len " + bin_8.length);
                    }
                }
                reader.onerror = function(){
                    console.log(reader.error);
                }
                return false;
            }
            function get_os_param(){
                let pack = {"request":"os_param",}
                let json_pack = JSON.stringify(pack);
                console.log("json_pack="+json_pack);
                let request = new XMLHttpRequest();
                request.open('GET', addr+ '/get_json.cgi');
                request.setRequestHeader('Json',json_pack);
                request.setRequestHeader('Accept','text/html');
                request.timeout = 5000;
                request.send();
                request.onreadystatechange = function () {
                    if (request.readyState == 4 && request.status == 200){
                        console.log("server response: "+request.responseText);
                        let json_response = JSON.parse(request.responseText);
                        document.getElementById("CUR").innerHTML = json_response.current;
                        current_os = json_response.current;
                        document.getElementById("MAIN").innerHTML = json_response.main;
                        main_os = json_response.main;
                      	document.getElementById("OV").innerHTML = json_response.os_ver;
                    }
                }
                request.ontimeout = function(){
                    console.log("Server is not responding");
                    alert("Server is not responding");
                }
            }
            function check(){
                return true;
            }
        </script>
    </head> 
    <body onload="get_os_param();">
        <h1>Download OS panel</h1>
        <table>
            <tr><td style="width:120px">OS VER:</td><td id="OV"></td></tr>
            <tr><td>CURRENT OS:</td><td id="CUR"></td></tr>
            <tr><td>MAIN OS:</td><td id="MAIN"></td></tr>
        </table>
        <br>
        <form id="os_form" name="os_form" enctype="multipart/form-data"
              onsubmit="return check()"  style="display:block; width: 300px">
            <fieldset>
                <legend id="legend">Please specify firmware binary file(bin):</legend>
                <input type="file" name="datafile" size="60" id="datafile_1" onchange="file('os_form')"><br>
            </fieldset>
        </form>
        <input type="button" id="download_button" value="download" onclick="send_file('os_form')" style="width: 100px;
         display:none">
        <a href="/index.html">Home</a>
        <br>
    </body>
</html>
